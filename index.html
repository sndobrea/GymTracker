<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://img.icons8.com/fluency/96/dumbbell.png" type="image/png">
    <!-- Viewport optimizat pentru aplicatii mobile (fara zoom) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GymPro">
    
    <title>Gym Tracker Pro</title>
    
    <!-- PWA Manifest Generator (Pentru Android Fullscreen) -->
    <script>
        const manifest = {
            "name": "Gym Tracker Pro",
            "short_name": "GymPro",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#09090b",
            "theme_color": "#09090b",
            "icons": [
                {
                    "src": "https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/dumbbell.svg",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/dumbbell.svg",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    // Safe area padding for iPhones with notch
                    spacing: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                },
            },
        }
    </script>

    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. FIREBASE SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
                apiKey: "AIzaSyAgQaJKzILCJJvUcELGAXhz5wboZFM49lw",
                authDomain: "snd-gym-tracker-app.firebaseapp.com",
                projectId: "snd-gym-tracker-app",
                storageBucket: "snd-gym-tracker-app.firebasestorage.app",
                messagingSenderId: "984835936224",
                appId: "1:984835936224:web:ee60695130dfe75dbd6585"
            };

        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);
        window.googleProvider = new GoogleAuthProvider();
        
        window.loginEmail = (email, pass) => signInWithEmailAndPassword(window.auth, email, pass);
        window.loginGoogle = () => signInWithPopup(window.auth, window.googleProvider);
        window.logout = () => signOut(window.auth);
        
        window.saveUserData = async (uid, data) => {
            try {
                await setDoc(doc(window.db, "users", uid), data, { merge: true });
                console.log("Data synced to cloud");
            } catch (e) {
                console.error("Error saving to cloud: ", e);
            }
        };
        
        window.getUserData = async (uid) => {
            const docRef = doc(window.db, "users", uid);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? docSnap.data() : null;
        };
    </script>
</head>
<body class="bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-50 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const svgRef = useRef(null);
            useEffect(() => {
                if (svgRef.current) {
                    const iconElement = document.createElement('i');
                    iconElement.setAttribute('data-lucide', name);
                    iconElement.setAttribute('width', size);
                    iconElement.setAttribute('height', size);
                    iconElement.setAttribute('class', className);
                    svgRef.current.innerHTML = '';
                    svgRef.current.appendChild(iconElement);
                    lucide.createIcons({ root: svgRef.current });
                }
            }, [name, size, className]);
            return <span ref={svgRef} className="inline-flex items-center justify-center" />;
        };

        const Icons = {
            Plus: (p) => <Icon name="plus" {...p} />,
            Minus: (p) => <Icon name="minus" {...p} />,
            ChevronLeft: (p) => <Icon name="chevron-left" {...p} />,
            ChevronRight: (p) => <Icon name="chevron-right" {...p} />,
            Trash2: (p) => <Icon name="trash-2" {...p} />,
            Edit2: (p) => <Icon name="pencil" {...p} />, 
            Dumbbell: (p) => <Icon name="dumbbell" {...p} />,
            Settings: (p) => <Icon name="settings" {...p} />,
            CheckCircle2: (p) => <Icon name="check-circle-2" {...p} />,
            Activity: (p) => <Icon name="activity" {...p} />,
            Moon: (p) => <Icon name="moon" {...p} />,
            Sun: (p) => <Icon name="sun" {...p} />,
            TrendingUp: (p) => <Icon name="trending-up" {...p} />,
            BarChart3: (p) => <Icon name="bar-chart-3" {...p} />,
            CalendarDays: (p) => <Icon name="calendar-days" {...p} />,
            Target: (p) => <Icon name="target" {...p} />,
            Download: (p) => <Icon name="download" {...p} />,
            Upload: (p) => <Icon name="upload" {...p} />,
            Save: (p) => <Icon name="save" {...p} />,
            AlertCircle: (p) => <Icon name="alert-circle" {...p} />,
            X: (p) => <Icon name="x" {...p} />,
            Check: (p) => <Icon name="check" {...p} />,
            ChevronDown: (p) => <Icon name="chevron-down" {...p} />,
            CalendarIcon: (p) => <Icon name="calendar" {...p} />,
            Layers: (p) => <Icon name="layers" {...p} />,
            Menu: (p) => <Icon name="menu" {...p} />,
            User: (p) => <Icon name="user" {...p} />,
            LogOut: (p) => <Icon name="log-out" {...p} />,
            LogIn: (p) => <Icon name="log-in" {...p} />,
            Cloud: (p) => <Icon name="cloud" {...p} />
        };

        const MUSCLE_GROUPS = [
            { value: 'legs', label: 'Legs' },
            { value: 'shoulders', label: 'Shoulders' },
            { value: 'triceps', label: 'Triceps' },
            { value: 'chest', label: 'Chest' },
            { value: 'biceps', label: 'Biceps' },
            { value: 'back', label: 'Back' },
            { value: 'abs', label: 'Abs' },
        ];

        // --- BASE COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', size = 'md', disabled = false }) => {
            const variants = {
                primary: "bg-zinc-900 text-white hover:bg-zinc-800 shadow-sm dark:bg-zinc-50 dark:text-zinc-900 dark:hover:bg-zinc-200",
                secondary: "bg-zinc-100 text-zinc-900 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-50 dark:hover:bg-zinc-700",
                ghost: "hover:bg-zinc-100 hover:text-zinc-900 dark:hover:bg-zinc-800 dark:hover:text-zinc-50",
                outline: "border border-zinc-200 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-900",
                destructive: "bg-red-600 text-white hover:bg-red-700 dark:bg-red-900 dark:text-red-50 dark:hover:bg-red-800",
            };
            const sizes = { sm: "h-8 px-3 text-xs", md: "h-10 px-4 py-2", lg: "h-12 px-6 text-lg", icon: "h-10 w-10" };
            return <button onClick={onClick} disabled={disabled} className={`inline-flex items-center justify-center rounded-lg font-medium transition-all active:scale-[0.98] disabled:opacity-50 ${variants[variant]} ${sizes[size]} ${className}`}>{children}</button>;
        };

        const Input = ({ label, value, onChange, type = "text", placeholder, className = "" }) => (
            <div className={`flex flex-col gap-2 ${className}`}>
                {label && <label className="text-xs font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400">{label}</label>}
                <input type={type} value={value} onChange={onChange} placeholder={placeholder} className="flex h-11 w-full rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-zinc-900 dark:border-zinc-800 dark:bg-zinc-950 dark:focus:ring-zinc-300 transition-shadow" />
            </div>
        );

        const Card = ({ children, className = "" }) => (
            <div className={`rounded-xl border border-zinc-200 bg-white text-zinc-950 shadow-sm dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-50 ${className}`}>{children}</div>
        );

        const Modal = ({ isOpen, onClose, title, children, footer }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-[fadeIn_0.2s_ease-out]">
                    <div className="w-full max-w-md bg-white dark:bg-zinc-900 rounded-xl shadow-2xl border border-zinc-200 dark:border-zinc-800 overflow-hidden animate-[zoomIn_0.2s_ease-out]">
                        <div className="flex items-center justify-between p-4 border-b border-zinc-100 dark:border-zinc-800">
                            <h3 className="font-bold text-lg">{title}</h3>
                            <button onClick={onClose}><Icons.X className="h-5 w-5 text-zinc-400" /></button>
                        </div>
                        <div className="p-6">{children}</div>
                        {footer && <div className="bg-zinc-50 dark:bg-zinc-950/50 p-4 border-t border-zinc-100 dark:border-zinc-800 flex justify-end gap-3">{footer}</div>}
                    </div>
                </div>
            );
        };

        // --- CUSTOM UI COMPONENTS ---
        const CustomSelect = ({ value, onChange, options, placeholder, label, className = "" }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);
            useEffect(() => {
                const handleClickOutside = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            const selectedOption = options.find(o => String(o.value) === String(value));
            return (
                <div className={`flex flex-col gap-2 ${className}`} ref={ref}>
                    {label && <label className="text-xs font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400">{label}</label>}
                    <div className="relative">
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className="flex h-11 w-full items-center justify-between rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm dark:border-zinc-800 dark:bg-zinc-950 focus:outline-none focus:ring-2 focus:ring-zinc-900 dark:focus:ring-zinc-300">
                            <span className={`truncate ${!selectedOption ? 'text-zinc-500' : ''}`}>{selectedOption ? selectedOption.label : placeholder}</span>
                            <Icons.ChevronDown className="h-4 w-4 opacity-50" />
                        </button>
                        {isOpen && (
                            <div className="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md border border-zinc-200 bg-white py-1 shadow-lg dark:border-zinc-800 dark:bg-zinc-950 animate-in fade-in zoom-in-95 duration-100">
                                {options.length === 0 ? (
                                    <div className="py-2 px-4 text-zinc-500 text-sm">No options</div>
                                ) : (
                                    options.map((opt) => (
                                        <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`relative cursor-pointer py-2 pl-10 pr-4 hover:bg-zinc-100 dark:hover:bg-zinc-800 ${String(value) === String(opt.value) ? 'bg-zinc-100 dark:bg-zinc-800 font-medium' : ''}`}>
                                            <span className="block truncate text-sm">{opt.label}</span>
                                            {String(value) === String(opt.value) && <span className="absolute left-3 top-2.5"><Icons.Check className="h-4 w-4" /></span>}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CustomDatePicker = ({ label, value, onChange, className = "" }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (ref.current && !ref.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const dateObj = value ? new Date(value) : new Date();
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const handleDayClick = (d) => {
                const selected = new Date(year, month, d);
                const offset = selected.getTimezoneOffset();
                const adjustedDate = new Date(selected.getTime() - (offset * 60 * 1000));
                onChange(adjustedDate.toISOString().split('T')[0]);
                setIsOpen(false);
            };

            const changeMonth = (offset) => {
                const newDate = new Date(year, month + offset, 1);
                const offsetTime = newDate.getTimezoneOffset();
                const adjusted = new Date(newDate.getTime() - (offsetTime * 60 * 1000));
                onChange(adjusted.toISOString().split('T')[0]);
            };

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const padding = Array.from({ length: firstDay });

            return (
                <div className={`flex flex-col gap-2 ${className}`} ref={ref}>
                    {label && <label className="text-xs font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-400">{label}</label>}
                    <div className="relative">
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className={`flex h-11 w-full items-center justify-start text-left rounded-lg border border-zinc-200 bg-white px-3 py-2 text-sm dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-100 ${!value ? 'text-zinc-500' : ''}`}>
                            <Icons.CalendarIcon className="mr-2 h-4 w-4 opacity-50" />
                            {value ? new Date(value).toLocaleDateString() : "Pick a date"}
                        </button>
                        {isOpen && (
                            <div className="absolute top-12 left-0 z-50 p-3 rounded-md border border-zinc-200 bg-white text-zinc-950 shadow-md dark:border-zinc-800 dark:bg-zinc-950 dark:text-zinc-50 w-[280px] animate-[fadeIn_0.1s_ease-out]">
                                <div className="flex items-center justify-between pb-4">
                                    <div className="text-sm font-medium">{monthNames[month]} {year}</div>
                                    <div className="flex gap-1">
                                        <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-zinc-100 rounded dark:hover:bg-zinc-800"><Icons.ChevronLeft className="h-4 w-4"/></button>
                                        <button onClick={() => changeMonth(1)} className="p-1 hover:bg-zinc-100 rounded dark:hover:bg-zinc-800"><Icons.ChevronRight className="h-4 w-4"/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center text-xs">
                                    {['Su','Mo','Tu','We','Th','Fr','Sa'].map(d => <div key={d} className="text-zinc-400">{d}</div>)}
                                    {padding.map((_, i) => <div key={`pad-${i}`}/>)}
                                    {days.map(d => (
                                        <button key={d} onClick={() => handleDayClick(d)} className={`h-8 w-8 rounded flex items-center justify-center hover:bg-zinc-100 dark:hover:bg-zinc-800 ${d === dateObj.getDate() ? 'bg-zinc-900 text-white dark:bg-zinc-100 dark:text-black font-bold' : ''}`}>{d}</button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ToastNotification = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            const bgColors = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? <Icons.Check className="h-4 w-4" /> : <Icons.AlertCircle className="h-4 w-4" />;
            return (
                <div className="fixed bottom-4 right-4 z-50 flex items-center gap-3 rounded-lg bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-4 py-3 shadow-lg animate-[slideIn_0.3s_ease-out]">
                    <div className={`rounded-full p-1 text-white ${bgColors}`}>{icon}</div>
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        // --- LOGIC HELPERS ---
        const getWeekNumber = (start) => {
            if (!start) return 0;
            const diff = new Date() - new Date(start);
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
        };

        // --- 1. NEW FIXED CALCULATION LOGIC (VIRTUAL GAIN) ---
        const calculateProgression = (ex, settings, weekIdx, workoutIdx) => {
            if (!ex || !settings) return null;
            const startW = parseFloat(ex.currentWeight) || 0;
            const endW = parseFloat(ex.targetWeight) || 0;
            const step = parseFloat(ex.increment) || 2.5;
            const tReps = parseInt(ex.targetReps) || 10;
            const sets = parseInt(settings.setsPerWorkout) || 3;
            
            const totalSessions = parseInt(settings.totalWeeks) * parseInt(settings.workoutsPerWeek);
            let sessionIdx = (weekIdx * parseInt(settings.workoutsPerWeek)) + workoutIdx;
            
            // Safety: Negative session or Future session beyond plan
            if (sessionIdx < 0) sessionIdx = 0;
            
            // If goal achieved/invalid
            if (endW <= startW) return { weight: startW, reps: Array(sets).fill(tReps) };

            // VIRTUAL GAIN LOGIC: 
            // We map the timeline not just to "endW", but to "endW + step".
            // This forces the "endW" plateau to start earlier and finish exactly at the last session.
            const virtualGain = (endW - startW) + step;
            
            // Linear progression through the VIRTUAL range
            const progressRatio = sessionIdx / (totalSessions > 1 ? totalSessions - 1 : 1);
            
            // Current virtual value
            const virtualValue = startW + (progressRatio * virtualGain);
            
            // Determine Weight: Snap to lower step
            // We use Math.min(endW) to clamp it so it never shows weight > target
            let weight = Math.min(endW, Math.floor(virtualValue / step) * step);
            
            // Determine Reps: Based on how far we are into the current weight step
            // remainder is 0.0 -> 0.999... of a step
            let remainder = (virtualValue - weight);
            
            // If we are clamped at endW, we might have overflowed in virtualValue, 
            // so we calculate remainder based on the final rep build-up.
            if (weight >= endW) {
                // Remainder is simply how close we are to "endW + step"
                // Recalculate linear pos relative to [endW, endW+step]
                remainder = virtualValue - endW;
            }

            // progressInStep (0.0 to 1.0)
            let progressInStep = remainder / step;
            if (progressInStep > 1) progressInStep = 1;
            if (progressInStep < 0) progressInStep = 0;

            const minReps = Math.max(1, tReps - 2);
            
            // Calculate total volume for the sets (e.g. 3 sets)
            // Interpolate between [minReps * sets] and [targetReps * sets]
            const minVol = sets * minReps;
            const maxVol = sets * tReps;
            const currentVol = Math.round(minVol + (progressInStep * (maxVol - minVol)));
            
            // Distribute volume
            const reps = Array(sets).fill(0);
            let remVol = currentVol;
            for(let i=0; i<sets; i++) {
                // Distribute evenly (front load slightly if needed)
                let val = Math.ceil(remVol / (sets - i));
                if (val > tReps) val = tReps; // Cap at max reps
                reps[i] = val;
                remVol -= val;
            }
            return { weight, reps };
        };

        // --- MAIN APP ---
        function GymTrackerApp() {
            const [user, setUser] = useState(null); 
            const [theme, setTheme] = useState('dark');
            const [activeTab, setActiveTab] = useState('tracker');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showSyncModal, setShowSyncModal] = useState(false);
            const [showUserMenu, setShowUserMenu] = useState(false); // NEW STATE FOR USER DROPDOWN
            const [loginEmail, setLoginEmail] = useState('');
            const [loginPass, setLoginPass] = useState('');
            
            const [settings, setSettings] = useState({
                totalWeeks: 45, workoutsPerWeek: 2, setsPerWorkout: 3,
                startDate: new Date().toISOString().split('T')[0],
                workoutNames: ["Legs-Shoulders-Triceps", "Chest-Back-Biceps"]
            });
            const [exercises, setExercises] = useState([]);
            const [history, setHistory] = useState({});

            const [newExercise, setNewExercise] = useState({
                name: '', currentWeight: '', increment: 2.5, targetReps: 10,
                targetWeight: '', assignedWorkout: 0, muscleGroup: 'legs'
            });
            const [isEditing, setIsEditing] = useState(null); 

            const [selectedExerciseId, setSelectedExerciseId] = useState(null);
            const [viewWeekOffset, setViewWeekOffset] = useState(0);
            const [filterWorkoutIndex, setFilterWorkoutIndex] = useState(0);
            const [filterMuscleGroup, setFilterMuscleGroup] = useState('all');

            const [notification, setNotification] = useState(null);
            const [importModalData, setImportModalData] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (localStorage.getItem('theme') === 'light') setTheme('light');
                const savedSettings = localStorage.getItem('gym_settings_v3');
                const savedExercises = localStorage.getItem('gym_exercises_v3');
                const savedHistory = localStorage.getItem('gym_history_v3');
                if (savedSettings) setSettings(JSON.parse(savedSettings));
                if (savedExercises) setExercises(JSON.parse(savedExercises));
                if (savedHistory) setHistory(JSON.parse(savedHistory));

                if (window.auth) {
                    const unsubscribe = window.auth.onAuthStateChanged(async (currentUser) => {
                        setUser(currentUser);
                        if (currentUser) {
                            const cloudData = await window.getUserData(currentUser.uid);
                            if (cloudData) {
                                if (savedExercises) setShowSyncModal(true); 
                                else applyData(cloudData);
                            } else syncToCloud(currentUser.uid); 
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => {
                document.documentElement.className = theme;
                localStorage.setItem('theme', theme);
            }, [theme]);

            // CLOSE DROPDOWN WHEN CLICKING OUTSIDE
            useEffect(() => {
                const closeMenu = (e) => {
                    if (showUserMenu && !e.target.closest('.user-menu-container')) {
                        setShowUserMenu(false);
                    }
                };
                document.addEventListener('click', closeMenu);
                return () => document.removeEventListener('click', closeMenu);
            }, [showUserMenu]);

            const persistData = (newSettings, newExercises, newHistory) => {
                const s = newSettings || settings;
                const e = newExercises || exercises;
                const h = newHistory || history;
                if (newSettings) { setSettings(newSettings); localStorage.setItem('gym_settings_v3', JSON.stringify(newSettings)); }
                if (newExercises) { setExercises(newExercises); localStorage.setItem('gym_exercises_v3', JSON.stringify(newExercises)); }
                if (newHistory) { setHistory(newHistory); localStorage.setItem('gym_history_v3', JSON.stringify(newHistory)); }
                if (user) window.saveUserData(user.uid, { settings: s, exercises: e, history: h, lastUpdated: new Date().toISOString() });
            };

            const syncToCloud = (uid) => window.saveUserData(uid || user.uid, { settings, exercises, history, lastUpdated: new Date().toISOString() });
            const applyData = (data) => {
                if (data.settings) setSettings(data.settings);
                if (data.exercises) setExercises(data.exercises);
                if (data.history) setHistory(data.history);
                localStorage.setItem('gym_settings_v3', JSON.stringify(data.settings));
                localStorage.setItem('gym_exercises_v3', JSON.stringify(data.exercises));
                localStorage.setItem('gym_history_v3', JSON.stringify(data.history));
            };

            const handleLogin = async (e) => { e.preventDefault(); try { await window.loginEmail(loginEmail, loginPass); setShowLoginModal(false); } catch (err) { alert("Login failed: " + err.message); } };
            const handleGoogleLogin = async () => { try { await window.loginGoogle(); setShowLoginModal(false); } catch (err) { alert("Google Login failed: " + err.message); } };
            const handleConfirmSync = async (useCloud) => { if (useCloud) { const cloudData = await window.getUserData(user.uid); applyData(cloudData); } else { syncToCloud(user.uid); } setShowSyncModal(false); };

            const addRoutine = () => {
                const newName = `Workout ${settings.workoutNames.length + 1}`;
                const newNames = [...settings.workoutNames, newName];
                persistData({ ...settings, workoutNames: newNames }, null, null);
            };

            const removeRoutine = (index) => {
                if (settings.workoutNames.length <= 1) {
                    setNotification({ message: "Must have at least one routine.", type: "error" });
                    return;
                }
                const newNames = settings.workoutNames.filter((_, i) => i !== index);
                persistData({ ...settings, workoutNames: newNames }, null, null);
            };

            const updateRoutineName = (index, val) => {
                const newNames = [...settings.workoutNames];
                newNames[index] = val;
                persistData({ ...settings, workoutNames: newNames }, null, null);
            };

            const addOrUpdateExercise = () => {
                if (!newExercise.name) return;
                let updatedList;
                if (isEditing) {
                    updatedList = exercises.map(ex => ex.id === isEditing ? { ...newExercise, id: isEditing } : ex);
                    setIsEditing(null);
                } else {
                    const ex = { ...newExercise, id: Date.now().toString(), assignedWorkout: parseInt(newExercise.assignedWorkout) };
                    updatedList = [...exercises, ex];
                    setFilterWorkoutIndex(ex.assignedWorkout);
                    setFilterMuscleGroup('all');
                    setSelectedExerciseId(ex.id);
                }
                persistData(null, updatedList, null);
                setNewExercise({ name: '', currentWeight: '', increment: 2.5, targetReps: 10, targetWeight: '', assignedWorkout: 0, muscleGroup: 'legs' });
            };

            const editExercise = (ex) => {
                setNewExercise(ex);
                setIsEditing(ex.id);
                setActiveTab('config'); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const removeExercise = (id) => {
                const updated = exercises.filter(e => e.id !== id);
                persistData(null, updated, null);
                if (selectedExerciseId === id) setSelectedExerciseId(null);
            };

            const toggleSetComplete = (weekIdx, workoutIdx, setIdx) => {
                if (!selectedExerciseId) return;
                const newHistory = { ...history };
                if (!newHistory[selectedExerciseId]) newHistory[selectedExerciseId] = {};
                if (!newHistory[selectedExerciseId][weekIdx]) newHistory[selectedExerciseId][weekIdx] = {};
                if (!newHistory[selectedExerciseId][weekIdx][workoutIdx]) newHistory[selectedExerciseId][weekIdx][workoutIdx] = {};
                newHistory[selectedExerciseId][weekIdx][workoutIdx][setIdx] = !newHistory[selectedExerciseId][weekIdx][workoutIdx][setIdx];
                persistData(null, null, newHistory);
            };

            const handleExportData = () => {
                const dataToExport = { version: 'v3', exportDate: new Date().toISOString(), settings, exercises, history };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gym_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setNotification({ message: 'Backup downloaded', type: 'success' });
            };

            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.settings && importedData.exercises) setImportModalData(importedData);
                        else setNotification({ message: 'Invalid file', type: 'error' });
                    } catch (error) { setNotification({ message: 'Error reading file', type: 'error' }); }
                };
                reader.readAsText(file);
                event.target.value = ''; 
            };

            const confirmImport = () => {
                if (!importModalData) return;
                persistData(importModalData.settings, importModalData.exercises, importModalData.history || {});
                setImportModalData(null); 
                setNotification({ message: 'Data imported successfully!', type: 'success' });
            };

            const currentWeekIndex = useMemo(() => getWeekNumber(settings.startDate), [settings.startDate]);
            const displayedWeekIndex = currentWeekIndex + viewWeekOffset;
            const routineExercises = useMemo(() => exercises.filter(e => (e.assignedWorkout || 0) === parseInt(filterWorkoutIndex)), [exercises, filterWorkoutIndex]);
            const availableMuscleGroups = useMemo(() => { const groups = new Set(routineExercises.map(e => e.muscleGroup)); return MUSCLE_GROUPS.filter(g => groups.has(g.value)); }, [routineExercises]);
            const filteredExercises = useMemo(() => { if (filterMuscleGroup === 'all') return routineExercises; return routineExercises.filter(e => e.muscleGroup === filterMuscleGroup); }, [routineExercises, filterMuscleGroup]);

            useEffect(() => {
                if (activeTab === 'tracker') {
                    const currentExists = filteredExercises.find(e => e.id === selectedExerciseId);
                    if (!currentExists && filteredExercises.length > 0) setSelectedExerciseId(filteredExercises[0].id);
                    else if (filteredExercises.length === 0) setSelectedExerciseId(null);
                }
            }, [activeTab, filterWorkoutIndex, filterMuscleGroup, filteredExercises.length]); 

            const selectedExercise = exercises.find(e => e.id === selectedExerciseId);
            const stats = useMemo(() => calculateProgression(selectedExercise, settings, displayedWeekIndex), [selectedExercise, settings, displayedWeekIndex]);
            const workoutsArray = Array.from({ length: parseInt(settings.workoutsPerWeek) || 0 });
            const setsArray = Array.from({ length: parseInt(settings.setsPerWorkout) || 0 });

            // --- 2. FIXED PROGRESS CALCULATION (REAL DATA) ---
            const progressionStats = useMemo(() => {
                if (!selectedExercise) return null;
                const gain = selectedExercise.targetWeight - selectedExercise.currentWeight;
                const step = selectedExercise.increment > 0 ? selectedExercise.increment : 1;
                const steps = Math.ceil(gain / step);
                const weeksPerInc = steps > 0 ? (settings.totalWeeks / steps).toFixed(1) : 0;
                
                // Real Progress Logic: Count checked sets vs Total sets needed
                const totalPossibleSets = parseInt(settings.totalWeeks) * parseInt(settings.workoutsPerWeek) * parseInt(settings.setsPerWorkout);
                
                let checkedCount = 0;
                const exHistory = history[selectedExerciseId];
                if (exHistory) {
                    // Traverse the history object deeply
                    Object.keys(exHistory).forEach(weekKey => {
                        const weekObj = exHistory[weekKey];
                        Object.keys(weekObj).forEach(workoutKey => {
                            const workoutObj = weekObj[workoutKey];
                            Object.keys(workoutObj).forEach(setKey => {
                                if (workoutObj[setKey] === true) checkedCount++;
                            });
                        });
                    });
                }

                let percent = 0;
                if (totalPossibleSets > 0) {
                    percent = ((checkedCount / totalPossibleSets) * 100).toFixed(1);
                }
                
                return { weeksPerInc, percent };
            }, [selectedExercise, settings, history, selectedExerciseId]); // Re-calc on history change

            return (
                <div className={`min-h-screen font-sans pb-20 safe-bottom ${theme === 'dark' ? 'bg-zinc-950 text-zinc-50' : 'bg-zinc-50 text-zinc-900'}`}>
                    {notification && <ToastNotification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    <Modal isOpen={!!importModalData} onClose={() => setImportModalData(null)} title="Confirm Import" footer={<><Button variant="ghost" onClick={() => setImportModalData(null)}>Cancel</Button><Button onClick={confirmImport}>Yes, Overwrite</Button></>}>
                        <div className="flex flex-col gap-3">
                            <div className="p-3 bg-yellow-50 text-yellow-800 rounded text-sm dark:bg-yellow-900/20 dark:text-yellow-200 font-bold flex gap-2"><Icons.AlertCircle className="h-5 w-5"/> This will replace your current data.</div>
                            <p className="text-sm text-zinc-500">Backup Date: {importModalData && new Date(importModalData.exportDate).toLocaleDateString()}</p>
                        </div>
                    </Modal>

                    <header className="sticky top-0 z-30 border-b border-zinc-200 bg-white/90 backdrop-blur-xl dark:border-zinc-800 dark:bg-zinc-950/90 safe-top">
                        <div className="container mx-auto flex h-16 items-center justify-between px-4 max-w-2xl">
                            <div className="flex items-center gap-2">
                                <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-zinc-900 text-white dark:bg-white dark:text-zinc-900"><Icons.Activity className="h-5 w-5" /></div>
                                <span className="text-lg font-bold tracking-tight">Gym<span className="opacity-50">Pro</span></span>
                            </div>
                            <div className="flex items-center gap-3">
                                {/* UPDATED USER MENU DROPDOWN */}
                                {user ? (
                                    <div className="relative user-menu-container">
                                        <button 
                                            onClick={() => setShowUserMenu(!showUserMenu)}
                                            className="flex items-center gap-2 bg-zinc-100 dark:bg-zinc-900 px-3 py-1.5 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-colors"
                                        >
                                            <Icons.User className="h-4 w-4 text-green-500" />
                                            <span className="text-xs font-bold hidden sm:block">Logged In</span>
                                            <Icons.ChevronDown className={`h-3 w-3 opacity-50 transition-transform ${showUserMenu ? 'rotate-180' : ''}`} />
                                        </button>
                                        
                                        {showUserMenu && (
                                            <div className="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl shadow-xl overflow-hidden z-50 animate-[fadeIn_0.1s_ease-out]">
                                                <div className="px-4 py-3 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-950/50">
                                                    <p className="text-[10px] text-zinc-400 uppercase tracking-wider font-bold mb-0.5">Account</p>
                                                    <p className="text-xs font-medium truncate" title={user.email}>{user.email}</p>
                                                </div>
                                                <button 
                                                    onClick={() => {
                                                        window.logout();
                                                        setShowUserMenu(false);
                                                    }}
                                                    className="w-full text-left px-4 py-3 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 flex items-center gap-2 transition-colors"
                                                >
                                                    <Icons.LogOut className="h-4 w-4" />
                                                    Sign Out
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <button onClick={() => setShowLoginModal(true)} className="flex items-center gap-1 text-sm font-medium hover:text-indigo-500"><Icons.LogIn className="h-4 w-4" /> Login</button>
                                )}

                                <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-800">{theme === 'dark' ? <Icons.Sun className="h-5 w-5" /> : <Icons.Moon className="h-5 w-5" />}</button>
                                <button className="sm:hidden p-2" onClick={() => setIsMenuOpen(!isMenuOpen)}>{isMenuOpen ? <Icons.X className="h-6 w-6" /> : <Icons.Menu className="h-6 w-6" />}</button>
                            </div>
                        </div>
                        {isMenuOpen && (
                            <div className="sm:hidden border-t border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 absolute w-full left-0 px-4 py-4 shadow-xl flex flex-col gap-2">
                                <button onClick={() => { setActiveTab('tracker'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium ${activeTab === 'tracker' ? 'bg-zinc-100 dark:bg-zinc-900' : ''}`}>Workout Tracker</button>
                                <button onClick={() => { setActiveTab('config'); setIsMenuOpen(false); }} className={`p-3 rounded-lg text-left font-medium ${activeTab === 'config' ? 'bg-zinc-100 dark:bg-zinc-900' : ''}`}>Settings & Database</button>
                                
                            </div>
                        )}
                        <div className="hidden sm:block container mx-auto px-4 pb-0 max-w-2xl">
                            <div className="flex gap-6 border-b border-transparent">
                                <button onClick={() => setActiveTab('tracker')} className={`pb-3 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'tracker' ? 'border-zinc-900 text-zinc-900 dark:border-white dark:text-white' : 'border-transparent text-zinc-500 hover:text-zinc-700'}`}>Tracker</button>
                                <button onClick={() => setActiveTab('config')} className={`pb-3 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'config' ? 'border-zinc-900 text-zinc-900 dark:border-white dark:text-white' : 'border-transparent text-zinc-500 hover:text-zinc-700'}`}>Database</button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4 max-w-2xl space-y-6">
                        {activeTab === 'config' && (
                            <div className="space-y-6 animate-[fadeIn_0.3s_ease-out]">
                                <section className="space-y-4">
                                    <div className="flex items-center gap-2 px-1"><Icons.Save className="h-4 w-4 text-zinc-500" /><h3 className="text-xs font-bold uppercase tracking-wider text-zinc-500">Data Management</h3></div>
                                    <Card className="p-5">
                                        <div className="flex flex-col sm:flex-row gap-4">
                                            <Button onClick={handleExportData} variant="outline" className="flex-1 gap-2"><Icons.Download className="h-4 w-4" /> Export JSON</Button>
                                            <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept=".json" className="hidden" />
                                            <Button onClick={() => fileInputRef.current?.click()} variant="outline" className="flex-1 gap-2"><Icons.Upload className="h-4 w-4" /> Import JSON</Button>
                                        </div>
                                    </Card>
                                </section>

                                <section className="space-y-4">
                                    <div className="flex items-center gap-2 px-1"><Icons.Settings className="h-4 w-4 text-zinc-500" /><h3 className="text-xs font-bold uppercase tracking-wider text-zinc-500">Global Config</h3></div>
                                    <Card className="p-5 grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <CustomDatePicker label="Start Date" value={settings.startDate} onChange={(val) => persistData({ ...settings, startDate: val })} />
                                        <Input label="Total Weeks" type="number" value={settings.totalWeeks} onChange={(e) => persistData({ ...settings, totalWeeks: e.target.value })} />
                                        <Input label="Workouts / Week" type="number" value={settings.workoutsPerWeek} onChange={(e) => persistData({ ...settings, workoutsPerWeek: e.target.value })} />
                                        <Input label="Sets / Exercise" type="number" value={settings.setsPerWorkout} onChange={(e) => persistData({ ...settings, setsPerWorkout: e.target.value })} />
                                    </Card>
                                    
                                    <Card className="p-5 space-y-3">
                                        <div className="flex justify-between items-center"><h4 className="text-sm font-bold">Workout Routines</h4><button onClick={addRoutine} className="p-1 hover:bg-zinc-100 rounded dark:hover:bg-zinc-800"><Icons.Plus className="h-4 w-4" /></button></div>
                                        <div className="space-y-2">
                                            {settings.workoutNames.map((name, idx) => (
                                                <div key={idx} className="flex gap-2">
                                                    <Input value={name} onChange={(e) => updateRoutineName(idx, e.target.value)} placeholder={`Routine ${idx + 1}`} />
                                                    <Button variant="ghost" onClick={() => removeRoutine(idx)} className="text-red-500"><Icons.Trash2 className="h-4 w-4" /></Button>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                </section>

                                <section className="space-y-4">
                                    <div className="flex items-center gap-2 px-1"><Icons.Plus className="h-4 w-4 text-zinc-500" /><h3 className="text-xs font-bold uppercase tracking-wider text-zinc-500">{isEditing ? 'Edit Exercise' : 'Add Exercise'}</h3></div>
                                    <Card className="p-5 space-y-4 border-l-4 border-l-indigo-500">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <Input label="Name" placeholder="Squats..." value={newExercise.name} onChange={(e) => setNewExercise({ ...newExercise, name: e.target.value })} />
                                            <CustomSelect label="Routine" value={newExercise.assignedWorkout} onChange={(val) => setNewExercise({ ...newExercise, assignedWorkout: val })} options={settings.workoutNames.map((n, i) => ({ value: i, label: n || `Workout ${i+1}` }))} placeholder="Select Routine" />
                                            <CustomSelect label="Muscle Group" value={newExercise.muscleGroup} onChange={(val) => setNewExercise({ ...newExercise, muscleGroup: val })} options={MUSCLE_GROUPS} placeholder="Select Muscle" />
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <Input label="Current (kg)" type="number" value={newExercise.currentWeight} onChange={(e) => setNewExercise({ ...newExercise, currentWeight: e.target.value })} />
                                            <Input label="Target (kg)" type="number" value={newExercise.targetWeight} onChange={(e) => setNewExercise({ ...newExercise, targetWeight: e.target.value })} />
                                            <Input label="Increment (kg)" type="number" value={newExercise.increment} onChange={(e) => setNewExercise({ ...newExercise, increment: e.target.value })} />
                                            <Input label="Max Reps" type="number" value={newExercise.targetReps} onChange={(e) => setNewExercise({ ...newExercise, targetReps: e.target.value })} />
                                        </div>
                                        <div className="flex gap-2">
                                            {isEditing && <Button variant="ghost" onClick={() => { setIsEditing(null); setNewExercise({ name: '', currentWeight: '', increment: 2.5, targetReps: 10, targetWeight: '', assignedWorkout: 0, muscleGroup: 'legs' }); }}>Cancel</Button>}
                                            <Button onClick={addOrUpdateExercise} className="w-full">{isEditing ? 'Update Exercise' : 'Add to Database'}</Button>
                                        </div>
                                    </Card>
                                </section>

                                <section className="space-y-3 pt-4">
                                    <h3 className="text-xs font-bold uppercase tracking-wider text-zinc-500 px-1">Exercise Database</h3>
                                    {exercises.map((ex) => (
                                        <div key={ex.id} className="group flex items-center justify-between p-4 bg-white border border-zinc-200 rounded-xl dark:bg-zinc-900/50 dark:border-zinc-800 shadow-sm">
                                            <div>
                                                <h4 className="font-bold text-lg">{ex.name}</h4>
                                                <div className="text-xs text-zinc-500 flex flex-wrap gap-2 mt-1">
                                                    <span className="bg-zinc-100 dark:bg-zinc-800 px-2 py-0.5 rounded">{settings.workoutNames[ex.assignedWorkout] || `Workout ${ex.assignedWorkout + 1}`}</span>
                                                    <span className="bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300 px-2 py-0.5 rounded capitalize">{ex.muscleGroup}</span>
                                                    <span>{ex.currentWeight}kg -> {ex.targetWeight}kg</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <button onClick={() => editExercise(ex)} className="p-2 text-zinc-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-lg dark:hover:bg-indigo-900/20"><Icons.Edit2 className="h-4 w-4" /></button>
                                                <button onClick={() => removeExercise(ex.id)} className="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 rounded-lg dark:hover:bg-red-900/20"><Icons.Trash2 className="h-4 w-4" /></button>
                                            </div>
                                        </div>
                                    ))}
                                    {exercises.length === 0 && <div className="p-8 text-center text-zinc-400 border border-dashed rounded-xl">Database empty.</div>}
                                </section>
                            </div>
                        )}

                        {activeTab === 'tracker' && (
                            <div className="space-y-6 animate-[fadeIn_0.3s_ease-out]">
                                <div className="flex p-1 bg-zinc-100 dark:bg-zinc-900 rounded-xl overflow-x-auto no-scrollbar">
                                    {settings.workoutNames.map((name, idx) => (
                                        <button key={idx} onClick={() => { setFilterWorkoutIndex(idx); setFilterMuscleGroup('all'); setSelectedExerciseId(null); }} className={`flex-1 py-2 px-4 text-sm font-medium rounded-lg transition-all whitespace-nowrap ${filterWorkoutIndex === idx ? 'bg-white shadow dark:bg-zinc-800 text-black dark:text-white' : 'text-zinc-500'}`}>{name || `Workout ${idx+1}`}</button>
                                    ))}
                                </div>

                                <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar -mx-2 px-2">
                                    <button onClick={() => setFilterMuscleGroup('all')} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold border transition-colors ${filterMuscleGroup === 'all' ? 'bg-zinc-900 text-white border-zinc-900 dark:bg-white dark:text-black' : 'bg-white border-zinc-200 dark:bg-zinc-950 dark:border-zinc-800'}`}>All</button>
                                    {availableMuscleGroups.map(g => (
                                        <button key={g.value} onClick={() => setFilterMuscleGroup(g.value)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-xs font-bold border transition-colors ${filterMuscleGroup === g.value ? 'bg-zinc-900 text-white border-zinc-900 dark:bg-white dark:text-black' : 'bg-white border-zinc-200 dark:bg-zinc-950 dark:text-zinc-400 dark:border-zinc-800 dark:hover:bg-zinc-900'}`}>{g.label}</button>
                                    ))}
                                </div>

                                <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar -mx-2 px-2 snap-x">
                                    {filteredExercises.length === 0 ? (
                                        <div className="text-sm text-zinc-400 italic px-2">No exercises found for this filter.</div>
                                    ) : (
                                        filteredExercises.map(ex => (
                                            <button 
                                                key={ex.id}
                                                onClick={() => { setSelectedExerciseId(ex.id); setViewWeekOffset(0); }}
                                                className={`snap-start shrink-0 w-[calc((100%-1.5rem)/3)] px-3 py-2 rounded-full border transition-all text-center flex flex-col items-center justify-center gap-1 shadow-sm ${
                                                    selectedExerciseId === ex.id 
                                                    ? 'border-zinc-900 bg-zinc-900 text-white dark:bg-zinc-100 dark:border-zinc-100 dark:text-zinc-900' 
                                                    : 'border-zinc-200 bg-white text-zinc-600 hover:border-zinc-300 dark:bg-zinc-950 dark:border-zinc-800 dark:text-zinc-400 dark:hover:border-zinc-700'
                                                }`}
                                            >
                                                <span className="text-xs font-semibold truncate w-full">
                                                    {ex.name}
                                                </span>
                                            </button>
                                        ))
                                    )}
                                </div>

                                {selectedExercise && stats && (
                                    <>
                                        <div className="flex items-center justify-between rounded-2xl bg-zinc-100 p-2 dark:bg-zinc-900/50">
                                            <Button variant="ghost" size="icon" onClick={() => setViewWeekOffset(p => p - 1)}><Icons.ChevronLeft className="h-5 w-5"/></Button>
                                            <div className="flex flex-col items-center">
                                                <span className="text-[10px] font-bold uppercase tracking-widest text-zinc-400">Week</span>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-xl font-black">{displayedWeekIndex + 1} <span className="text-sm text-zinc-400 font-medium">/ {settings.totalWeeks}</span></span>
                                                    {/* RESTORED GREEN DOT */}
                                                    {viewWeekOffset === 0 && <span className="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>}
                                                </div>
                                            </div>
                                            <Button variant="ghost" size="icon" onClick={() => setViewWeekOffset(p => p + 1)}><Icons.ChevronRight className="h-5 w-5"/></Button>
                                        </div>

                                        <div className="space-y-4">
                                            {workoutsArray.map((_, wIdx) => {
                                                const sessionData = calculateProgression(selectedExercise, settings, displayedWeekIndex, wIdx);
                                                if(!sessionData) return null;
                                                return (
                                                    <Card key={wIdx} className="overflow-hidden border-0 shadow-lg dark:shadow-none ring-1 ring-zinc-200 dark:ring-zinc-800">
                                                        <div className="bg-zinc-50 px-5 py-3 border-b border-zinc-100 dark:bg-zinc-900 dark:border-zinc-800 flex justify-between items-center">
                                                            <div className="flex items-center gap-2">
                                                                <div className="h-6 w-6 rounded bg-zinc-900 text-white flex items-center justify-center text-xs font-bold dark:bg-white dark:text-black">{String.fromCharCode(65+wIdx)}</div>
                                                                <span className="font-bold">Session</span>
                                                            </div>
                                                            <span className="text-sm font-semibold bg-white px-2 py-1 rounded shadow-sm border border-zinc-100 dark:bg-zinc-800 dark:border-zinc-700">{sessionData.weight} <span className="text-xs text-zinc-400">KG</span></span>
                                                        </div>
                                                        <div className="divide-y divide-zinc-100 dark:divide-zinc-800">
                                                            {setsArray.map((_, sIdx) => {
                                                                const isDone = history[selectedExerciseId]?.[displayedWeekIndex]?.[wIdx]?.[sIdx];
                                                                return (
                                                                    <div key={sIdx} className={`flex items-center justify-between px-5 py-3 ${isDone ? 'bg-green-50/50 dark:bg-green-900/10' : ''}`}>
                                                                        <span className="text-xs font-bold text-zinc-400 w-8">#{sIdx+1}</span>
                                                                        <div className="flex items-baseline gap-1">
                                                                            <span className={`text-2xl font-black tracking-tighter ${isDone ? 'text-green-600 dark:text-green-400' : ''}`}>{sessionData.reps[sIdx]}</span>
                                                                            <span className="text-[10px] font-bold uppercase text-zinc-400">reps</span>
                                                                        </div>
                                                                        <button onClick={() => toggleSetComplete(displayedWeekIndex, wIdx, sIdx)} className={`h-8 w-8 rounded-full flex items-center justify-center transition-all ${isDone ? 'bg-green-500 text-white shadow-lg shadow-green-500/30' : 'bg-zinc-100 text-zinc-300 dark:bg-zinc-800 dark:text-zinc-600'}`}>
                                                                            <Icons.CheckCircle2 className={`h-5 w-5 ${isDone ? 'stroke-[3px]' : ''}`} />
                                                                        </button>
                                                                    </div>
                                                                )
                                                            })}
                                                        </div>
                                                    </Card>
                                                )
                                            })}
                                        </div>

                                        {/* STATS VISUALIZATION */}
                                        <div className="mt-8 overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm transition-all dark:border-zinc-700/50 dark:bg-zinc-900">
                                            <div className="p-6">
                                                <div className="flex items-center justify-between mb-6">
                                                    <div className="flex items-center gap-3">
                                                        <div className="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-500/10 text-indigo-600 dark:bg-indigo-500/20 dark:text-indigo-400">
                                                            <Icons.BarChart3 className="h-5 w-5" />
                                                        </div>
                                                        <div>
                                                            <h4 className="text-sm font-medium text-zinc-500 dark:text-zinc-400">Performance</h4>
                                                            <p className="text-lg font-bold text-zinc-900 dark:text-zinc-100">Progression Stats</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 gap-6">
                                                    <div className="space-y-1">
                                                        <span className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">
                                                            <Icons.CalendarDays className="h-3 w-3" />
                                                            Frequency
                                                        </span>
                                                        <p className="text-2xl font-bold tracking-tight text-zinc-800 dark:text-zinc-200">
                                                            {progressionStats ? progressionStats.weeksPerInc : '-'} <span className="text-sm font-normal text-zinc-500">weeks</span>
                                                        </p>
                                                    </div>

                                                    <div className="space-y-1 text-right">
                                                        <span className="flex items-center justify-end gap-2 text-xs font-semibold uppercase tracking-wider text-zinc-400">
                                                            <Icons.Target className="h-3 w-3" />
                                                            Completed
                                                        </span>
                                                        <p className="text-2xl font-bold tracking-tight text-zinc-800 dark:text-zinc-200">
                                                            {progressionStats ? progressionStats.percent : 0}%
                                                        </p>
                                                    </div>
                                                </div>

                                                <div className="mt-6">
                                                    <div className="relative h-3 w-full rounded-full bg-zinc-100 dark:bg-zinc-800">
                                                        <div
                                                            className="absolute inset-y-0 left-0 rounded-full bg-indigo-600 transition-all duration-1000 ease-out dark:bg-indigo-500"
                                                            style={{ 
                                                                width: `${progressionStats ? progressionStats.percent : 0}%`,
                                                                boxShadow: '0 0 12px rgba(79, 70, 229, 0.4)' 
                                                            }}
                                                        />
                                                    </div>
                                                    <div className="mt-2 flex justify-between text-[10px] font-medium uppercase tracking-tighter text-zinc-400">
                                                        <span>0%</span>
                                                        <span>100%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                )}
                                
                                {filteredExercises.length === 0 && (
                                    <div className="py-20 text-center opacity-50 flex flex-col items-center">
                                        <Icons.Layers className="h-12 w-12 mb-2"/>
                                        <p>No exercises found.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <Modal isOpen={showLoginModal} onClose={() => setShowLoginModal(false)} title="Sign In">
                        <div className="space-y-4">
                            <form onSubmit={handleLogin} className="space-y-3">
                                <Input label="Email" type="email" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} />
                                <Input label="Password" type="password" value={loginPass} onChange={(e) => setLoginPass(e.target.value)} />
                                <Button className="w-full">Login with Email</Button>
                            </form>
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center"><span className="w-full border-t border-zinc-200 dark:border-zinc-700"></span></div>
                                <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-zinc-500 dark:bg-zinc-900">Or continue with</span></div>
                            </div>
                            <Button variant="outline" className="w-full gap-2" onClick={handleGoogleLogin}>
                                <svg className="h-4 w-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26.81-.58z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                Google
                            </Button>
                        </div>
                    </Modal>

                    <Modal isOpen={showSyncModal} onClose={() => setShowSyncModal(false)} title="Sync Conflict">
                        <div className="space-y-4">
                            <div className="p-3 bg-indigo-50 text-indigo-700 rounded-lg text-sm dark:bg-indigo-900/30 dark:text-indigo-300">We found existing data in your Cloud account.</div>
                            <p className="text-sm text-zinc-600 dark:text-zinc-400">Do you want to overwrite your local data with the Cloud backup, or overwrite the Cloud with your current local data?</p>
                            <div className="flex flex-col gap-2">
                                <Button onClick={() => handleConfirmSync(true)} className="w-full">Download from Cloud (Recommended)</Button>
                                <Button onClick={() => handleConfirmSync(false)} variant="outline" className="w-full">Upload Local to Cloud</Button>
                            </div>
                        </div>
                    </Modal>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GymTrackerApp />);
    </script>
</body>
</html>
